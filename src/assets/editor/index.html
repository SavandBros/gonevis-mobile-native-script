<!DOCTYPE html>
<html>
<head>
  <link href="./quill.snow.css" rel="stylesheet">
  <script src="./quill.js"></script>
  <script src="./nativescript-webview-interface.js"></script>
  <script src="./config.js"></script>
  <link href="./editor.css" rel="stylesheet">
</head>
<body>
<div style="height: calc(100% - 50px);">
  <div id="editor"></div>
</div>
<div id="toolbar">
  <span class="ql-formats highlight-buttons">
    <button class="ql-bold"></button>
    <button class="ql-italic"></button>
    <button class="ql-link"></button>
  </span>
  <span class="ql-formats inline-buttons">
    <button class="ql-header" value="1"></button>
    <button class="ql-header" value="2"></button>
    <button class="ql-blockquote"></button>
    <button class="ql-list" value="ordered"></button>
    <button class="ql-list" value="bullet"></button>
    <button class="ql-direction" value="rtl"></button>
  </span>
</div>
</div>
<script>
  (function () {
    "use strict";
    let oldContent;
    const Delta = Quill.import('delta');

    let editor = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Content',
      modules: {
        toolbar: '#toolbar'
      },
      scrollingContainer: '.ql-editor',
      bounds: '.ql-editor'
    });
    const oWebViewInterface = window.nsWebViewInterface;
    window.getContent = function () {
      return {
        content: editor.root.innerHTML,
        contentEquality: JSON.stringify(oldContent) === JSON.stringify(editor.getContents())
      };
    };

    editor.on('selection-change', function (range, oldRange, source) {
      // Toolbar element.
      const toolbar = document.getElementById('toolbar');

      if (range) {
        if (range.length === 0) {
          // Remove highlight mode.
          toolbar.classList.remove('highlighting-mode');
          // Update selection.
          editor.selection.update(Quill.sources.SILENT);
          // Get editor's bounds based on range's index.
          let bounds = editor.getBounds(range.index);
          // Scroll to current cursor.
          editor.scrollingContainer.scrollTop = bounds.top;
          // Scroll into view.
          editor.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
        } else {
          toolbar.classList.add('highlighting-mode');
        }
      }
    });
    oWebViewInterface.on('setContent', function (eventData) {
      editor.setContents(editor.clipboard.convert(eventData));
      oldContent = Object.assign({}, editor.getContents());
    });
  })();
</script>
</body>
</html>
